{% extends "layout/base.html" %}

{# If a user chooses these fields, they carry between different pages. #}
{% set product_args = {
    'product_name': product.name,
    'year': year,
    'month': month,
    'day': day
} %}

{% block title %}{{ product.name }}{% endblock %}

{% block header %}
    <nav>
        <ul>
            {% set navigation_bar = [
                ('overview', 'product.overview_page'),
                ('datasets', 'product.search_page'),
            ] -%}
            {% for id, page_method in navigation_bar %}
                <li{% if id == active_page %} class="active"{% endif %}>
                    <a href="{{ url_for(page_method, **product_args) }}">
                        {{ id | title }}
                    </a>
                </li>
            {% endfor %}
            <li class="plain"><a href="{{ url_for('about_page') }}">About</a></li>
        </ul>
    </nav>
    <header>
        {# Go to current page with different product/year/month options#}
        {% set nav_endpoint=request.url_rule.endpoint %}

        <div class="header-option">
            <div><strong>{{ product.definition.description }}</strong></div>
            <ul>
                {% for product_opt, summary in products if summary %}
                    {% if product_opt.name != product.name %}
                        <li>
                            <a href="{{ url_for(request.url_rule.endpoint, product_name=product_opt.name) }}"
                               title="{{ product_opt.definition.description }}">
                                {{ product_opt.name }}
                                {#                            ({{ summary.dataset_count }})#}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                {# If they're viewing a product without summaries generated, it wont be in the list above #}
                {% if not product_summary %}
                    <option value="{{ product.name }}" selected="selected">
                        {{ product.name }}
                    </option>
                {% endif %}
            </ul>
        </div>
        {% if product %}
            <div class="header-option">
                <div>{{ year or 'All years' }}</div>
                <ul>
                    {% if year %}
                        <li>
                            <a href="{{ url_for(nav_endpoint, product_name=product.name) }}">All</a>
                        </li>
                    {% endif %}
                    {% for year_opt in (range(
                        product_summary.time_range.end.year,
                        product_summary.time_range.begin.year - 1,
                        -1
                    ) if (product_summary and product_summary.time_range) else range(current_time.year, 1985, -1)) %}
                        {% if (year_opt) != year %}
                            <li>
                                <a href="{{ url_for(request.url_rule.endpoint, product_name=product.name, year=year_opt) }}">
                                    {{ year_opt }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if year %}
            <div class="header-option">
                <div>
                    {% if month %}
                        {{ month | month_name }}
                    {% else %}
                        All months
                    {% endif %}
                </div>
                <ul>
                    {% if month %}
                        <li>
                            <a href="{{ url_for(nav_endpoint, product_name=product.name, year=year) }}">All</a>
                        </li>
                    {% endif %}
                    {% for month_opt in range(1, 13) %}
                        {% if (month_opt) != month %}
                            <li>
                                <a href="{{ url_for(
                                    request.url_rule.endpoint,
                                    product_name=product.name,
                                    year=year,
                                    month=month_opt
                                    ) }}">
                                    {{ month_opt | month_name }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if month %}
            <div class="header-option">
                <div>{{ day or 'All days' }}</div>
                <ul id='select-day' aria-label="Day">
                    <li>
                        <a href="{{ url_for(nav_endpoint, product_name=product.name, year=year, month=month) }}">
                            All
                        </a>
                    </li>
                    {% for day_opt in range(1, 31) %}
                        {% if (day_opt) != day %}
                            <li>
                                <a href="{{ url_for(
                                        request.url_rule.endpoint,
                                        product_name=product.name,
                                        year=year,
                                        month=month,
                                        day=day_opt
                                        ) }}">
                                    {{ day_opt }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </header>
{% endblock %}



{% block footer %}
    {{ super() }}
    <script>
        // TODO offset for current page
        var base_url = {% if active_page == 'datasets' %}'/datasets/'{% else %}'/'{% endif %};

        function _url_for_selection(product, year, month, day) {
            /**
             * Build url: "/product_name/yyyy/mm/dd"
             *
             * All components optional
             *
             * Examples:
             *     /
             *     /ls7_nbar_scene
             *     /ls7_nbar_scene/2012
             *     /ls7_nbar_scene/2012/07
             *     /ls7_nbar_scene/2012/07/03
             */


            var url = base_url;

            if (product) {
                url += product;
                [year, month, day].some(function (number) {
                    if (!number) {
                        // Don't join any further.
                        return true;
                    }

                    url += '/';
                    url += (number < 10 ? '0' : '') + number;
                    return false;
                });
            }
            return url;
        }

        $('#select-product, #select-month, #select-year, #select-day').change(function () {
            var product = $('#select-product :selected').val(),
                year = $('#select-year :selected').val(),
                month = year ? $('#select-month :selected').val() : null,
                day = month ? $('#select-day :selected').val() : null;

            window.location.href = _url_for_selection(product, year, month, day);
        });
    </script>
{% endblock %}
