{% extends "layout/product-section.html" %}
{% set active_page = "overview" %}
{% block title %}{{ product.name }}{% endblock %}


{% block content %}
    {% from "layout/macros.html" import query_param_list, show_raw_document %}

    <div class="panels">
        <div class="map-panel relative">
            <div id="msg-no-results" class="message-box">
                {% if selected_summary %}
                    <span>No displayable datasets for period</span>
                {% else %}
                    <span>No data: not yet generated</span>
                {% endif %}
            </div>
            <div id="map"></div>
        </div>
        {% if product %}
            <div>
                <div class="panel highlight product-description">
                    {{ product.definition.description }}
                </div>
                <div class="panel info-panel">
                    {% if year %}
                        <h3>
                        {% if month %}
                            {% if day %}{{ day }}
                            {% endif %}
                            {{ month | month_name }}
                        {% endif %}
                        {{ year }}
                        </h3>
                    {% endif %}
                    <a href="{{ url_for('search_page', **product_args) }}" class="muted dataset-count"
                    >{{ selected_summary.dataset_count if selected_summary else 'Unknown number of' }} datasets</a>

                    {% if selected_summary.dataset_count != selected_summary.footprint_count %}
                        ({{ selected_summary.footprint_count or 'None' }} visible)
                    {% endif %}

                <ul>
                    {% if selected_summary.size_bytes %}
                        <li class="coverage-filesize">{{ selected_summary.size_bytes | printable_data_size }}</li>
                    {% endif %}

                    {% if selected_summary.footprint_geometry %}
                        <li class="coverage-footprint-area">{{ selected_summary.footprint_geometry | albers_area}} (approx.)</li>
                    {% endif %}
                    {% if selected_summary.region_dataset_counts %}
                        <li class="coverage-region-count">
                            {{ selected_summary.region_dataset_counts | length }} unique regions
                        </li>
                    {% endif %}
                    {% if selected_summary.crses %}
                        <li class="coverage-crs-count" title="{{  selected_summary.crses | join(', ') }}">
                            {{ selected_summary.crses | length}}
                            dataset CRS{% if selected_summary.crses | length == 1 %}:
                            {{ selected_summary.crses|join(',') }}
                            {% endif %}
                        </li>
                    {% endif %}

                    {% if selected_summary.newest_dataset_creation_time %}
                        <li class="last-processed">
                            Last processed {{ selected_summary.newest_dataset_creation_time | timesince }}
                        </li>
                    {% endif %}
                </ul>

                <h4>Fields ({{ product.metadata_type.name }})</h4>

                {{ query_param_list(product.fields, descriptions=product.metadata_type.dataset_fields) }}


                {# These fields are enforced by dataset-type-schema.yaml #}
                {% if product.definition.storage %}
                    <h4>Storage</h4>
                    {{ query_param_list(product.definition.storage, show_dicts=true) }}
                {% endif %}

                {% if product.definition.measurements %}
                    <h4>Measurements</h4>
                    <ul>
                        {% for measurement in product.definition.measurements %}
                            <li>
                                <div>
                                    {% for a in measurement.aliases %}<span class="muted">{{ a }}</span>
                                        / {% endfor %}
                                    <span class="muted">{{ measurement.name }}</span>
                                </div>
                                {#                            <div>#}
                                {#                                type {{ measurement.dtype }};#}
                                {#                                units {{ measurement.units }};#}
                                {#                                nodata {{ measurement.nodata }}#}
                                {#                            </div>#}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}


                <p>
                    <a href="{{ url_for('product.product_page', name=product.name) }}"
                       class="muted">raw metadata</a>
                </p>

                {# Mostly useful for debugging: hide in page source code. Users should look at page footer instead. #}
                {% if selected_summary.newest_dataset_creation_time %}
                <!-- Summarised {{ selected_summary.summary_gen_time | timesince }} -->
                {% endif %}
            </div>



        {% endif %}
    </div>
{% endblock %}


{% block body_footer %}

    {{ super() }}

    {% from "layout/macros.html" import chart_timeline %}
    <script type="application/javascript">
        (function () {
            var msgNoResults = document.getElementById("msg-no-results");
            {% if selected_summary.footprint_count %}
                msgNoResults.style.display = 'none';
            {% endif %}

            var osm_carto_light = L.tileLayer(
                "//cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",
                {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors,' +
                        ' &copy; <a href="https://cartodb.com/attributions">CartoDB</a>'
                }
            );

            var map = L.map("map", {
                zoom: 3,
                center: [-26.2756326, 134.9387844],
                layers: [osm_carto_light],
                zoomControl: false,
                attributionControl: false,
                scrollWheelZoom: false
            });
            L.control.groupedLayers(
                {
                    "Topography": osm_carto_light,
                    "Imagery": L.layerGroup([
                            L.tileLayer(
                                "//basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/" +
                                "tile/{z}/{y}/{x}",
                                {
                                    maxZoom: 15
                                }
                            ),
                            L.tileLayer.wms(
                                "//raster.nationalmap.gov/arcgis/services/Orthoimagery/USGS_EROS_Ortho_SCALE/" +
                                "ImageServer/WMSServer?",
                                {
                                    minZoom: 16,
                                    maxZoom: 19,
                                    layers: "0",
                                    format: 'image/jpeg',
                                    transparent: true,
                                    attribution: "Aerial Imagery courtesy USGS"
                                }
                            )
                        ]
                    )
                },
                {},
                {
                    position: 'bottomright',
                    collapsed: false
                }
            ).addTo(map);

            L.control.zoom({position: "bottomright"}).addTo(map);

            let getBin = function (v, bin_count) {
                    let min_v = our_data.regions.data.properties.min_count,
                        max_v = our_data.regions.data.properties.max_count,
                        range = max_v - min_v,
                        val = v - min_v;

                    if (range < bin_count) {
                        var padding = bin_count - range;
                        return padding + val - 1;
                    } else {
                        var bin_width = range / bin_count;
                        return Math.round(val / bin_width) - 1;
                    }
                },
                getColor = function (count) {
                    let colorSteps = ['#eff3ff', '#c6dbef', '#9ecae1', '#6baed6', '#3182bd', '#08519c'],
                        bin = getBin(count, colorSteps.length);
                    return colorSteps[bin];
                };

            let we_have_data = {{ 'true' if selected_summary.footprint_count > 0 else 'false' }},
                our_data = {
                    datasets: {
                        url: '{{ url_for('api.datasets_geojson', **product_args) }}',
                        data: null,
                        geojson_layer: L.geoJson(null, {
                            style: function (feature) {
                                return {
                                    color: "#7AB800",
                                    fill: true,
                                    fillColor: "#9aee00",
                                    opacity: 0.3,
                                    weight: 2,
                                    clickable: true
                                };
                            },
                            onEachFeature: function (feature, layer) {
                                var that = our_data.datasets;
                                layer.on({
                                    mouseover: function (e) {
                                        var layer = e.target;

                                        layer.setStyle({
                                            color: '#375400',
                                            fillOpacity: 0.6
                                        });

                                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                            layer.bringToFront();
                                        }

                                        var props = layer.feature.properties,
                                            template = '<div><strong>' + props.label + '</strong></div>' + props.start_time;
                                        datasetInfoControl.update(template);
                                    }
                                    ,
                                    mouseout: function (e) {
                                        that.geojson_layer.resetStyle(e.target);
                                        var show_count = that.data.features.length;
                                        datasetInfoControl.update('Sample of '+show_count+' datasets');
                                    },
                                    click: function (e) {
                                        var props = e.target.feature.properties;
                                        window.location.href = '/dataset/' + props.id;
                                    }
                                });
                            }
                        }),
                    },
                    regions: {
                        url: '{{ url_for('api.regions_geojson', **product_args) }}',
                        data: null,
                        geojson_layer: L.geoJson(null,
                            {
                                style: function (feature) {
                                    return {
                                        color: "#f2f2f2",
                                        fill: true,
                                        fillColor: getColor(feature.properties.count),
                                        opacity: 0.6,
                                        fillOpacity: 0.4,
                                        weight: 1,
                                        clickable: false
                                    };
                                },
                                onEachFeature: function (feature, layer) {
                                    var that = our_data.regions;
                                    layer.on({
                                        mouseover: function (e) {
                                            var layer = e.target;

                                            layer.setStyle({
                                                color: '#375400',
                                            });

                                            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                                layer.bringToFront();
                                            }
                                            let props = layer.feature.properties,
                                                data = that.data,
                                                template = '<div><strong>' + data.properties.region_item_name + ' ' +
                                                    props.region_code +
                                                    '</strong></div>' +
                                                    props.count +
                                                    ' dataset(s)';
                                            datasetInfoControl.update(template);
                                        }
                                        ,
                                        mouseout: function (e) {
                                            that.geojson_layer.resetStyle(e.target);
                                            datasetInfoControl.update();
                                        },
                                        click: function (e) {
                                            {#var props = e.target.feature.properties;#}
                                            {#window.location.href = '/dataset/' + props.id;#}
                                        }
                                    });
                                }
                            })
                    },
                    footprint: {
                        url: '{{ url_for('api.footprint_geojson', **product_args) }}',
                        data: {{ footprint_geojson | tojson }},
                        geojson_layer: L.geoJson(null,
                            {
                                interactive: false,
                                style: function (feature) {
                                    return {
                                        color: "#00A1DE",
                                        fill: true,
                                        fillColor: "#8FCAE7",
                                        opacity: 0.3,
                                        weight: 2,
                                        clickable: false
                                    };
                                }
                            }
                        )
                    }
                },
                our_active_data = null;

            {# Show information for the hovered item #}
            var datasetInfoControl = L.control({position: "bottomleft"});
            datasetInfoControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'dataset-info');
                this.update();
                return this._div;
            };
            datasetInfoControl.update = function (template) {
                if (template) {
                    this._div.innerHTML = template;
                } else {
                    this._div.innerHTML = '';
                }
            };
            map.addControl(datasetInfoControl);

            function set_active_layer(new_layer) {
                if (our_active_data) {
                    map.removeLayer(our_active_data.geojson_layer);
                }
                map.addLayer(new_layer.geojson_layer);
                our_active_data = new_layer;
            }

            // Default to footprint
            if (we_have_data) {
                our_data.footprint.geojson_layer.addData(our_data.footprint.data);
                set_active_layer(our_data.footprint);
                map.fitBounds(our_active_data.geojson_layer.getBounds(), {animate: false, maxZoom: 6});
            }


            {% if selected_summary.timeline_dataset_counts and (selected_summary.timeline_dataset_counts | length > 1) %}
                var timelineControl = L.control({position: "topright"});
                timelineControl.onAdd = function (map) {
                    var div = L.DomUtil.create("div", "timeline-control");
                    div.innerHTML = {{
                        chart_timeline(
                            selected_summary.timeline_dataset_counts,
                            product,
                            period=selected_summary.timeline_period
                        ) | tojson
                        }};
                    return div;
                };
                map.addControl(timelineControl);
            {% endif %}


            function report_error(msg) {
                // TODO: message box?
                document.getElementById('quiet-page-errors').innerText += msg +'<br/>';
            }

            function request_data(data_spec) {
                var request = new XMLHttpRequest();
                request.open('GET', data_spec.url, true);
                request.onload = function () {
                    if (request.status >= 200 && request.status < 400) {
                        data_spec.data = JSON.parse(request.responseText);
                        data_spec.geojson_layer.addData(data_spec.data);
                    } else {
                        // We reached our target server, but it returned an error
                        report_error('Error fetching ' + data_spec.url);
                    }
                };
                request.onerror = function () {
                    // There was a connection error of some sort
                    report_error('Error fetching ' + data_spec.url)
                };
                request.send();
            }

            // Load in background
            request_data(our_data.regions);
            request_data(our_data.datasets);


            window.MAP = map;
            window.SET_ACTIVE_LAYER = function (name) {
                let new_layer = our_data[name];
                set_active_layer(new_layer);
            };
        })();
    </script>
{% endblock %}
